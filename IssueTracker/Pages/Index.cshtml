@page
@model IssueTracker.Pages.IndexModel
@{
    ViewData["Title"] = "Dashboard";
}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Issue Dashboard</h2>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-primary" asp-page="/Issues/Index">View All</a>
    <a class="btn btn-success" asp-page="/Issues/Create">+ New Issue</a>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-3"><div class="card"><div class="card-body">
    <div class="text-muted">Open</div>
    <div class="fs-3 fw-bold">@Model.OpenCount</div>
  </div></div></div>

  <div class="col-md-3"><div class="card"><div class="card-body">
    <div class="text-muted">In Progress</div>
    <div class="fs-3 fw-bold">@Model.InProgressCount</div>
  </div></div></div>

  <div class="col-md-3"><div class="card"><div class="card-body">
    <div class="text-muted">Blocked</div>
    <div class="fs-3 fw-bold">@Model.BlockedCount</div>
  </div></div></div>

  <div class="col-md-3"><div class="card"><div class="card-body">
    <div class="text-muted">Resolved Today</div>
    <div class="fs-3 fw-bold">@Model.ResolvedToday</div>
  </div></div></div>
</div>

<h5 class="mb-2">Recent Open Issues</h5>
<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        @* <th>ID</th> *@
        <th>Date</th>
        <th>Reporter</th>
        <th>URL</th>
        <th>Type</th>
        <th>Priority</th>
        <th>Assigned</th>
        <th>Screenshot</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      @if (!Model.RecentOpen.Any())
      {
        <tr><td colspan="8" class="text-muted">No open issues.</td></tr>
      }
      else
      {
        @foreach (var i in Model.RecentOpen)
        {
          <tr>
            @* <td>@i.Id</td> *@
            <td>@(i.DateReported?.ToString("yyyy-MM-dd"))</td>
            <td>@i.ReporterName</td>
            <td><a href="@i.WebsiteUrl" target="_blank" rel="noopener">@i.WebsiteUrl</a></td>
            <td>@i.IssueType</td>
            <td><span class="badge bg-priority-@i.IssuePriority.ToLower()">@i.IssuePriority</span></td>
            <td>@i.AssignedTo</td>
            <td class="text-nowrap">
  @if (!string.IsNullOrWhiteSpace(i.Screenshot))
  {
      <a class="btn btn-sm btn-outline-primary"
         href="@i.Screenshot"
         target="_blank" rel="noopener">
         View
      </a>
  }
  else
  {
      <button class="btn btn-sm btn-outline-secondary" disabled>None</button>
  }
</td>
<td>
  @{
      var d = i.IssueDescription ?? string.Empty;
      var preview = d.Length > 120 ? d[..120] + "â€¦" : d;
  }
  <span>@preview</span>
  @if (d.Length > 120)
  {
      <button type="button" class="btn btn-link btn-sm p-0 ms-1"
              data-bs-toggle="modal" data-bs-target="#desc-@i.Id">
          View
      </button>

      <div class="modal fade" id="desc-@i.Id" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered"
       style="height: 90vh; max-width: 900px;"> 
    <div class="modal-content" style="height: 100%;">  
      <div class="modal-header">
        <h5 class="modal-title">Issue Description</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="overflow: auto;">  
        <pre class="mb-0" style="white-space:pre-wrap">@d</pre>
      </div>
    </div>
  </div>
</div>
  }
</td>


            <td class="text-nowrap">
              <a class="btn btn-sm btn-outline-secondary" asp-page="/Issues/Edit" asp-route-id="@i.Id">Edit</a>
            </td>
          </tr>
        }
      }
    </tbody>
  </table>
</div>
